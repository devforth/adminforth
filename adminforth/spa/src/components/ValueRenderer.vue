<template>
  <div>
    <span @click="(e)=>{e.stopPropagation()}" v-if="column.foreignResource">
      <RouterLink v-if="record[column.name]" class="font-medium text-lightPrimary dark:text-darkPrimary hover:brightness-110 whitespace-nowrap"
        :to="{ name: 'resource-show', params: { resourceId: column.foreignResource.resourceId, primaryKey: record[column.name].pk } }">
        {{ record[column.name].label }}
      </RouterLink>
      <div v-else>
        <span class="text-gray-400">-</span>
      </div>
    </span>
        
    <span v-else-if="column.type === 'boolean'">
      <span v-if="record[column.name]" class="bg-green-100 text-green-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded dark:bg-gray-700 dark:text-green-400 border border-green-400">Yes</span>
      <span v-else class="bg-red-100 text-red-800 text-xs font-medium me-2 px-2.5 py-0.5 rounded dark:bg-gray-700 dark:text-red-400 border border-red-400">No</span>
    </span>
    <span v-else-if="column.enum">
      {{ checkEmptyValues(column.enum.find(e => e.value === record[column.name])?.label || record[column.name], route.meta.type) }}
    </span>
    <span v-else-if="column.type === 'datetime'" class="whitespace-nowrap">
      {{ checkEmptyValues(formatDateTime(record[column.name]),route.meta.type) }}
    </span>
    <span v-else-if="column.type === 'date'" class="whitespace-nowrap">
      {{ checkEmptyValues(formatDate(record[column.name]),route.meta.type) }}
    </span>
    <span v-else-if="column.type === 'time'" class="whitespace-nowrap">
      {{ checkEmptyValues(formatTime(record[column.name]),route.meta.type) }}
    </span>
    <span v-else-if="column.type === 'richtext'">
      <div v-html="protectAgainstXSS(record[column.name])" class="allow-lists"></div>
    </span>
    <span v-else-if="column.type === 'json'">
      <JsonViewer :value="record[column.name]" :expandDepth="column?.extra?.jsonCollapsedLevel" copyable sort :theme="coreStore.theme" />

    </span>
    <span v-else>
      {{ checkEmptyValues(record[column.name],route.meta.type) }}
    </span>
  </div>
</template>


<script setup>

import dayjs from 'dayjs';
import utc from 'dayjs/plugin/utc';
import timezone from 'dayjs/plugin/timezone';
import {checkEmptyValues} from '@/utils';
import { useRoute, useRouter } from 'vue-router';
import sanitizeHtml from 'sanitize-html';
import { JsonViewer } from "vue3-json-viewer";
import "vue3-json-viewer/dist/index.css";


import { useCoreStore } from '@/stores/core';
import { computed } from 'vue';

const coreStore = useCoreStore();
const route = useRoute();


dayjs.extend(utc);
dayjs.extend(timezone);

const props = defineProps({
  column: Object,
  record: Object
});

console.log('props', props.column?.extra?.jsonCollapsedLevel);


function protectAgainstXSS(value) {
  return sanitizeHtml(value, {
    allowedTags: [
      "address", "article", "aside", "footer", "header", "h1", "h2", "h3", "h4",
      "h5", "h6", "hgroup", "main", "nav", "section", "blockquote", "dd", "div",
      "dl", "dt", "figcaption", "figure", "hr", "li", "main", "ol", "p", "pre",
      "ul", "a", "abbr", "b", "bdi", "bdo", "br", "cite", "code", "data", "dfn",
      "em", "i", "kbd", "mark", "q", "rb", "rp", "rt", "rtc", "ruby", "s", "samp",
      "small", "span", "strong", "sub", "sup", "time", "u", "var", "wbr", "caption",
      "col", "colgroup", "table", "tbody", "td", "tfoot", "th", "thead", "tr", 'img'
    ],
    allowedAttributes: {
      'li': [ 'data-list' ],
      'img': [ 'src', 'srcset', 'alt', 'title', 'width', 'height', 'loading' ]
    } 
  });
}


function formatDateTime(date) {
  if (!date) return '';
  return dayjs.utc(date).local().format(`${coreStore.config?.datesFormat} ${coreStore.config?.timeFormat}` || 'YYYY-MM-DD HH:mm:ss');
}

function formatDate(date) {
  if (!date) return '';
  return dayjs.utc(date).local().format(coreStore.config?.datesFormat || 'YYYY-MM-DD');
}

function formatTime(time) {
  if (!time) return '';
  return dayjs(`0000-00-00 ${time}`).format(coreStore.config?.timeFormat || 'HH:mm:ss');
}
</script>

<style lang="scss">

.allow-lists {
  ol {
    list-style-type: decimal;
    padding-left: 1.5em;

    li[data-list="bullet"] {
      list-style-type: disc;
    }
    li[data-list="ordered"] {
      list-style-type: decimal;
    }
  }

} 
</style>

<style lang="scss" >

.jv-container .jv-code {
  padding: 10px 10px;
}

.jv-container .jv-button[class] {
  @apply text-lightPrimary;
  @apply dark:text-darkPrimary;

}

.jv-container.jv-dark {
  background: transparent;
}

</style>